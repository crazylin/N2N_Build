name: Build n2n on Windows

on:
  workflow_dispatch

jobs:
  build-windows:
    name: Build Windows (${{ matrix.compiler }})
    runs-on: windows-latest
    strategy:
      matrix:
        compiler: [msvc, mingw]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup build environment
      if: matrix.compiler == 'msvc'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install MinGW dependencies
      if: matrix.compiler == 'mingw'
      run: |
        choco install mingw -y
        refreshenv

    - name: Configure CMake
      shell: cmd
      run: |
        mkdir build
        cd build
        cmake .. -G "%CMAKE_GENERATOR%" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DN2N_OPTION_USE_PTHREAD=OFF
      env:
        CMAKE_GENERATOR: >-
          ${{ matrix.compiler == 'msvc' && 'Visual Studio 17 2022' || 'MinGW Makefiles' }}

    - name: Build project
      shell: cmd
      run: |
        cd build
        cmake --build . --config Release --parallel 2

    - name: Collect artifacts
      shell: cmd
      run: |
        mkdir artifacts
        copy build\edge\Release\edge.exe artifacts
        copy build\supernode\Release\supernode.exe artifacts

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: n2n-windows-${{ matrix.compiler }}
        path: artifacts/*
