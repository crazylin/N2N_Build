name: Build n2n on Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1

    - name: Install OpenSSL
      run: |
        # 下载预编译的 OpenSSL (适用于 Windows 的 64 位版本)
        $url = "https://slproweb.com/download/Win64OpenSSL-3_1_4.msi"
        Invoke-WebRequest -Uri $url -OutFile openssl.msi
        msiexec.exe /i openssl.msi /quiet /qn /norestart
        # 添加 OpenSSL 到系统路径
        $opensslPath = "C:\Program Files\OpenSSL-Win64\bin"
        echo "C:\Program Files\OpenSSL-Win64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "$opensslPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Configure with CMake
      run: |
        cmake -B build -S . `
          -G "Visual Studio 17 2022" -A x64 `
          -DOPENSSL_ROOT_DIR="$env:ProgramFiles\OpenSSL-Win64"

    - name: Build the project
      run: cmake --build build --config Release --target edge supernode

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Windows-Binaries
        path: |
          build/Release/edge.exe
          build/Release/supernode.exe