name: Build n2n on Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-2022  # 显式指定与日志匹配的环境

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # 更新到最新稳定版

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.3.1  # 指定明确版本

    - name: Install OpenSSL
      run: |
        $url = "https://slproweb.com/download/Win64OpenSSL-3_1_4.msi"
        Invoke-WebRequest -Uri $url -OutFile openssl.msi
        Start-Process msiexec.exe -ArgumentList "/i openssl.msi /quiet /qn /norestart" -Wait
        $env:Path += ";C:\Program Files\OpenSSL-Win64\bin"
        echo "OPENSSL_ROOT_DIR=C:\Program Files\OpenSSL-Win64" >> $env:GITHUB_ENV

    - name: Configure CMake
      shell: cmd  # 强制使用 CMD 避免 PowerShell 转义问题
      run: |
        cmake -B build -S . ^
          -G "Visual Studio 17 2022" -A x64 ^
          -DOPENSSL_ROOT_DIR="%OPENSSL_ROOT_DIR%"

    - name: Build project
      run: cmake --build build --config Release --parallel 4

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4  # 升级到最新版本
      with:
        name: Windows-Binaries
        path: |
          build/Release/edge.exe
          build/Release/supernode.exe
        retention-days: 5